{% extends 'base.html' %}

{% block head %}
{% endblock %}

{% block header %}
  {% include 'header.html' %}
{% endblock %}

{% block main %}

  <h1>Welcome to {{ application_name }}!</h1>

  <form action="/book/upload" method="post" enctype="multipart/form-data">
    Select book to upload:
    <input type="file" name="fileToUpload" id="fileToUpload">
    <input type="submit" value="Upload File" name="submit">
  </form>

  <progress id="progress-bar" max=100 value=0></progress>

  Books:
  <ul class="books" id="books-drop">
    {% for book in books %}
    <li>
      <div class="title">{{ book }}</div>
      <div class="controls">
        <button>View</button>
        <button>Delete</button>
      </div>
    </li>
    {% endfor %}
  </ul>

  <script>
    let dropArea = document.getElementById('books-drop')

    // prevent defaults
    ;['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropArea.addEventListener(eventName, preventDefaults, false)
    })
    function preventDefaults (e) {
      e.preventDefault()
      e.stopPropagation()
    }

    // highlighting drop area
    ;['dragenter', 'dragover'].forEach(eventName => {
      dropArea.addEventListener(eventName, highlight, false)
    })
    dropArea.addEventListener('dragleave', function(e) {
      if(e.pageX != 0 || e.pageY != 0) {
        return false
      }
      unhighlight()
    }, false)
    dropArea.addEventListener('drop', unhighlight, false)
    function highlight(e) {
      dropArea.classList.add('highlight')
    }
    function unhighlight(e) {
      dropArea.classList.remove('highlight')
    }

    // file drop
    dropArea.addEventListener('drop', handleDrop, false)
    function handleDrop(e) {
      let dt = e.dataTransfer
      let files = dt.files

      handleFiles(files)
    }
    function handleFiles(files) {
      files = [...files]
      initializeProgress(files.length)
      files.forEach(uploadFile)
      files.forEach(previewFile)
    }
    function uploadFile(file) {
      let url = '/book/upload'
      let formData = new FormData()
      formData.append('fileToUpload', file)

      fetch(url, {
        method: 'POST',
        body: formData
      })
      .then(() => { console.log('uploaded') })
      .then(progressDone)
      .catch((err) => { console.error(err) })
    }
    function previewFile(file) {
      let reader = new FileReader()
      reader.readAsDataURL(file)
      reader.onloadend = function() {
        let img = document.createElement('img')
        img.src = reader.result
        document.getElementById('gallery').appendChild(img)
      }
    }

    // progress
    let filesDone = 0
    let filesToDo = 0
    let progressBar = document.getElementById('progress-bar')
    function initializeProgress(numfiles) {
      progressBar.value = 0
      filesDone = 0
      filesToDo = numfiles
    }
    function progressDone() {
      filesDone++
      progressBar.value = filesDone / filesToDo * 100
    }
  </script>

{% endblock %}
